# Baking Rack
[![Tests](https://github.com/dcunning/baking_rack/workflows/Tests/badge.svg)](https://github.com/dcunning/baking_rack/actions?query=workflow%3ATests)

Bake and Push static webpages generated by [a Rack application](https://github.com/rack/rack/).

![Baking Rack Logo](https://github.com/dcunning/baking_rack/blob/main/logo.png?raw=true)

## Table of Contents

- [Why?](#why)
- [Getting Started](#getting-started)
- [Usage](#usage)
  - [Ruby on Rails](#ruby-on-rails)
  - [AWS S3](#aws-s3)
- [Contributing](#contributing)
- [Versioning](#versioning)
- [License](#license)

## Why?

### Why static webpages?

When paired with a good hosting service, static webpages are cheaper to host, easier to maintain, and harder to hack than dynamic ones because there are less moving parts.

### Why one more Ruby static webpage generator?

`BakingRack` is a narrowly-focused library, not an all-encompassing framework.

Jekyll, Middleman, Nanoc, and Bridgetown are frameworks that define how your site is organized. `BakingRack` is only interested in your site being [a Rack app](https://github.com/rack/rack/) (protip: all those frameworks support Rack) in order to gather its static pages and publish them to a static webserver or CDN.

## Getting Started

Start by including `baking_rack` in your Gemfile:

```ruby
gem 'baking_rack'

# (if using the AWS S3 deployer)
gem 'aws-sdk-s3'
```

Then run `bundle install`.

## Configuration

```ruby
# config/initializers/baking_rack.rb (in Rails)

BakingRack.config do |c|
  c.builder = BakingRack::Builder.new
  c.deployer = BakingRack::Deployers::AwsS3.new

  c.define_static_routes do
    # Render this explicit path using your Rack app.
    get "/about.html"

    # Collect routes from static data
    BlogPost.find_each do |post|
      get post.path
    end

    # Expect statuses other than 200
    get "/404.html", status: 404
  end
end
```

```bash
# view available commands
$ bundle exec baking_rack help

# view a specific command's options
$ bundle exec baking_rack help [COMMAND]

# perform the build and deploy
$ bundle exec baking_rack publish
```

### Dry Run

Deployers support the `dry_run` keyword argument which instructs it to output what will be deployed without actually performing it.

### Ruby on Rails

`BakingRack` provides some additional help for building static webpages from Ruby on Rails applications, just use its custom builder class:

```ruby
BakingRack.config do |c|
  c.builder = BakingRack::Rails::Build.new

  b.static_routes do
    # path helpers are exposed here
    get root_path
  end
end
```

Intelligent defaults:

* `app` defaults to `Rails.application`
* `domain_name` defaults to `Rails.application.config.hosts.first`

### AWS + Terraform

1. Define the terraform module

```terraform
module "baking_rack" {
  source = "git@github.com:dcunning/baking_rack.git//terraform?ref=main"

  bucket_name       = "${module.label.id}-www"
  domain_name       = var.domain_name
  github_repository = var.github_repository
  branch_name       = var.github_branch_name
}
```

2. Add an origin to your CloudFront distribution

```terraform
  origin {
    domain_name = module.baking_rack_bucket.website_endpoint
    origin_id   = "S3-${module.baking_rack.bucket_name}"

    custom_origin_config {
      http_port              = 80
      https_port             = 443
      origin_protocol_policy = "http-only"
      origin_ssl_protocols   = ["TLSv1", "TLSv1.1", "TLSv1.2"]
    }

    custom_header {
      name  = "User-Agent"
      value = module.baking_rack.handshake
    }
  }
```

3. Define some terraform outputs

These outputs are used by the `aws_github_publish` generator.

```
output "baking_rack_iam_role_arn" {
  value = module.baking_rack.iam_role_arn
}

output "baking_rack_bucket_name" {
  value = module.baking_rack.bucket_name
}
```

4. Apply the terraform plan

```bash
terraform init
terraform apply
```

5. Generate a GitHub workflow

Use GitHub Actions to automatically publish the latest `main` to the S3 bucket.

```
bundle exec baking_rack publish_via_github
```

## Contributing

If you have problems, please create a [GitHub Issue](/.github/ISSUE_TEMPLATE/bug-report.md).

## Versioning

`baking_rack` follows Semantic Versioning 2.0 as defined at https://semver.org.

## License

This code is free to use under the terms of the MIT license.
